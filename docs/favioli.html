<html data-reactroot=""><head><meta name="author" content="Ben Pevsner"/><meta name="title" content="Ben Pevsner"/><meta name="description" content="Eating candy and doin stuff"/><meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0"/><link rel="shortcut icon" href="/static/favicon.ico"/><link href="https://unpkg.com/basscss@8.0.2/css/basscss.min.css" rel="stylesheet"/><link rel="stylesheet" type="text/css" href="/static/highlight-styles.css"/><link rel="stylesheet" type="text/css" href="/static/index.css"/><title>Ben Pevsner</title><noscript><style>.jsonly { display: none }</style></noscript></head><body><div><div class="content sans-serif container m2 block mx-auto fit-800 pl3 pr3 justify-center"><nav class="fit "><a href="/" class="h1 m1 black text-decoration-none header-title">Ben Pevsner</a></nav><section class="clearfix mx-auto"><div class="mt4 mb4 mx-auto fit-800 article"><h1 id="favioli-üëä">Favioli üëä</h1><p>Favioli is a productivity extension that makes it easier to recognize tabs within your browser. Like this:</p><p><a href="https://static.bpev.me/images/favioli-comparison.png" target="_blank"><img src="https://static.bpev.me/images/favioli-comparison.png?width=750&amp;height=750&amp;fit=outside" alt="Favioli Example" class="col-12 image"/></a></p><p>Favioli was originally inspired by two things. The first thing that spurred the idea was Eli Grey‚Äôs <a href="https://eligrey.com" context="[object Object]">personal site</a> and its use of javascript to make a rotating emoji favicon. The favicon of his site is a different emoji each time that persists within a session. It‚Äôs pretty creative and fun! This was the creative inspiration for Favioli (fyi: Eli consolidated his emoji-to-favicon code into <a href="https://github.com/eligrey/emoji-favicon-toolkit" context="[object Object]">Emoji Favicon Toolkit</a>, if you want to use it in your own project)!</p><p>The practical inspiration for Favioli came from my day job. We have a lot of internal tools and sites, and they tend to either not have favicons, or have the standard Sony logo. For me this was a bit of a pain, because I love to pin my tabs. I couldn‚Äôt tell these sites apart.</p><p>I could use a Chrome extension that lets me set custom favicons, but then I‚Äôd have to go through and specify each one. If I were to use emojis, I wouldn‚Äôt have to deal with finding art for each individual site, and I could make something that could automatically make all of these pages recognizable at a glance.</p><h2 id="favioli-üëä-building-favioli">Building Favioli</h2><p> Also, I probably could have used existing exmoji selectors instead of customizing an existing npm plugin. That being said, the project has been a fun exploration of javascript strings, chrome extensions, and browser/os string support.</p><p>As we look through everything, feel free to follow along by looking at Favioli‚Äôs <a href="https://github.com/ivebencrazy/favioli" context="[object Object]">source code</a>! All the Favioli code that is my own is licensed with the <a href="https://unlicense.org/" context="[object Object]">Unlicense</a>, so feel free to go crazy with it.</p><h3 id="favioli-üëä-building-favioli-structure-of-a-browser-extension">Structure of a Browser Extension</h3><p>There are essentially 4 pieces of any fully-local web extension that modifies a web page:</p><ul context="[object Object]" class=""><li>Options: The internal website that extensions use for full-screen setting updates</li><li>Popup: The mini-website that pops up when you click the extension icon</li><li>Background: The background extension process that does stuff‚Ä¶ in the background‚Ä¶</li><li>ContentScript: The script that gets added to websites you visit in your web browser.</li></ul><p>We use all of these except popup for Favioli.  The general structure of our extension looks like this:</p><p><a href="https://static.bpev.me/images/favioli-structure.jpg" target="_blank"><img src="https://static.bpev.me/images/favioli-structure.jpg?width=750&amp;height=750&amp;fit=outside" alt="Favioli&amp;#39;s Structure" class="col-12 image"/></a></p><p>There are essentially 4 pieces of any fully-local web extension that modifies a web page. Favioli currently takes advantage of 3 of these:</p><h4 id="favioli-üëä-building-favioli-structure-of-a-browser-extension-settings:-options-and-popup-pages">Settings: Options and Popup Pages</h4><p>This is the simplest piece of Favioli, and for a good reason; it doesn‚Äôt really do much. All we do here is run a basic website, ‚Äúoptions.html‚Äù, which saves data to a browser-provided storage mechanism.  Similar to using localStorage, key differences being that it can sync between different browsers on multiple computers, and is available to other areas of our Chrome Extension that don‚Äôt interact with a webpage. What this boils down to in Favioli is simply saving custom overrides and, in the future, things like icon packs and other settings.</p><p><a href="https://static.bpev.me/images/favioli-options.png" target="_blank"><img src="https://static.bpev.me/images/favioli-options.png?width=750&amp;height=750&amp;fit=outside" alt="Options Page" class="col-12 image"/></a></p><p>The most complicated piece of the options page is the emoji selector, adapted from Dominic Valenicana‚Äôs <a href="https://github.com/Kiricon/emoji-selector" context="[object Object]">Emoji Selector</a>. We use this to define a custom HTML element that we can use for the options page.</p><p>One thing we haven‚Äôt implemented in Favioli is a popup page. In Chrome Extension land, the ‚Äúpopup‚Äù is the mini-site that shows up when you click the extenstion icon.  We currently don‚Äôt use this for Favioli, but it would be extremely useful for quick-pinning specific emojis to sites we are currently visiting. It would essentially follow the same formula as our Options page, though; featuring a user interface that simply feeds information to our background process.</p><h4 id="favioli-üëä-building-favioli-structure-of-a-browser-extension-background:-the-decision-engine">Background: The Decision Engine</h4><p>The Background process is Favioli‚Äôs primary decision engine.  It takes information from our content script and background process, and spits the correct emoji to each page. Our decision is a simple priority list: we just check each item and use the first rule to apply:</p><table><thead><tr><th>Priority</th><th>Rule</th></tr></thead><tbody><tr><td>1</td><td><strong>User-set Overrides</strong>: If a user has specified a favicon match via the options page, then the site will use that favicon.</td></tr><tr><td>2</td><td><strong>Site Default</strong>: If the site has a favicon, then use that.</td></tr><tr><td>3</td><td><strong>Random Emoji</strong>: If the site has not natural favicon, we generate a random one via a hashing algorithm.</td></tr></tbody></table><p>The user-set overrides and site defaults are pretty straightforward; we can match pieces of a url, or match a regex. If it doesn‚Äôt use those, then fall back to the site‚Äôs default favicon. The more interesting case is if a site doesn‚Äôt have a native Favicon.</p><h5 id="favioli-üëä-building-favioli-structure-of-a-browser-extension-background:-the-decision-engine-random-emoji-hash">Random Emoji Hash</h5><p>The reasoning for using a non-cryptographic hash to determine emojis is based on one idea: there‚Äôs no way in hell we‚Äôre storing the settings of each site a person visits. THAT would be a pain in the ass. We use a hash of the website‚Äôs host to map to an emoji with a custom set of char codes (we don‚Äôt really want to randomly apply flag and symbol emojis to all the sites. It‚Äôs just not as fun). This creates a function that creates a random emoji that is always the same for an individual website host, without storing any data.</p><h4 id="favioli-üëä-building-favioli-structure-of-a-browser-extension-background:-applying-the-favicon">Background: Applying the Favicon</h4><p>Our decision process is run in 3 cases, which are in the background.js:</p><pre><code class="language-javascript"><span class="hljs-comment">// After we fetch our settings, start listening for url updates</span>
<span class="hljs-title function_">init</span>().<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
  <span class="hljs-comment">// If a tab updates, check to see whether we should set a favicon</span>
  chrome.<span class="hljs-property">tabs</span>.<span class="hljs-property">onUpdated</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">tabId, opts, tab</span>) {
    <span class="hljs-title function_">tryToSetFavicon</span>(tabId, tab)
  })
})

<span class="hljs-comment">// Manually sent Chrome messages</span>
chrome.<span class="hljs-property">runtime</span>.<span class="hljs-property">onMessage</span>.<span class="hljs-title function_">addListener</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">message, details</span>) {
  <span class="hljs-comment">// If we manually say a tab has been updated, try to set favicon</span>
  <span class="hljs-comment">// This happens when contentScript loads before settings are ready</span>
  <span class="hljs-keyword">if</span> (message === <span class="hljs-string">&quot;updated:tab&quot;</span>) <span class="hljs-title function_">tryToSetFavicon</span>(details.<span class="hljs-property">tab</span>.<span class="hljs-property">id</span>, details.<span class="hljs-property">tab</span>)

  <span class="hljs-comment">// If our settings change, re-run init to fetch new settings</span>
  <span class="hljs-keyword">if</span> (message === <span class="hljs-string">&quot;updated:settings&quot;</span>) <span class="hljs-title function_">init</span>()
})</code></pre><p><code>tryToSetFavicon</code> decides what emoji we want to use and sends it to our content script as an emoji message string, to render our emoji as a favicon. Our content script has a few additional checks for whether we should show our favicon, because there are some checks that can only be done on each individual site.</p><p>We can think of our bakground process as determining <strong>WHEN</strong> to set a favicon, and <strong>WHAT</strong> to set it as. The content script will determine <strong>IF</strong> a favicon truly gets set.</p><h4 id="favioli-üëä-building-favioli-structure-of-a-browser-extension-content-script:-building-text-favicons">Content Script: Building Text Favicons</h4><p>Our content script is the script that runs on each website we visit, appending or replacing the favicon when our background process tells it to. This scripts could be quite a bit simpler than we made it. The reason? Essentially, this boils down to one thing:</p><blockquote><p>Favicons are images. Emojis are not images.</p></blockquote><p>Unfortunately, favicons still must be images, so we have to do a bit of hackery magic in order to show our native text emojis show up as favicons. This was the clever bit of code Eli wrote that I borrowed to make Favioli an image-less experience.</p><p>I should probably mention that there‚Äôs definitely some over-engineering in Favioli. Practically, using the same clever method as Eli for creating legitimate emoji text favicons is not reeeeally necessary, and makes for some complications when it comes to multi-platform support. So this script coooould be ‚Äúuse a pre-rendered emoji image and add it as a favicon.‚Äù That script would be easy, but WHAT FUN WOULD THAT BE?!?!</p><p>Let‚Äôs jump into a condensed version of <a href="https://github.com/ivebencrazy/favioli/blob/master/source/utilities/faviconHelpers.js#L60" context="[object Object]">the code we use</a> to create our favicons:</p><pre><code class="language-javascript"><span class="hljs-comment">// Initialize canvas and context to render emojis</span>

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PIXEL_GRID</span> = <span class="hljs-number">16</span> <span class="hljs-comment">// Standard favIcon size 16x16</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">EMOJI_SIZE</span> = <span class="hljs-number">256</span> <span class="hljs-comment">// 16 x 16</span>

<span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&quot;canvas&quot;</span>)
canvas.<span class="hljs-property">width</span> = canvas.<span class="hljs-property">height</span> = <span class="hljs-variable constant_">EMOJI_SIZE</span>

<span class="hljs-keyword">const</span> context = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">&quot;2d&quot;</span>)
context.<span class="hljs-property">font</span> = <span class="hljs-string">`normal normal normal <span class="hljs-subst">${EMOJI_SIZE}</span>px/<span class="hljs-subst">${EMOJI_SIZE}</span>px sans-serif`</span>
context.<span class="hljs-property">textAlign</span> = <span class="hljs-string">&quot;center&quot;</span>
context.<span class="hljs-property">textBaseline</span> = <span class="hljs-string">&quot;middle&quot;</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createEmojiUrl</span>(<span class="hljs-params">char</span>) {
  <span class="hljs-keyword">const</span> { width } = context.<span class="hljs-title function_">measureText</span>(char)

  <span class="hljs-comment">// Bottom and Left of the emoji (where we start drawing on canvas)</span>
  <span class="hljs-comment">// Since favicons are a square, we can use the same number for both</span>
  <span class="hljs-keyword">const</span> center = (<span class="hljs-variable constant_">EMOJI_SIZE</span> + <span class="hljs-variable constant_">EMOJI_SIZE</span> / <span class="hljs-variable constant_">PIXEL_GRID</span>) / <span class="hljs-number">2</span>
  <span class="hljs-keyword">const</span> scale = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable constant_">EMOJI_SIZE</span> / width, <span class="hljs-number">1</span>) <span class="hljs-comment">// Adjust canvas to fit</span>
  <span class="hljs-keyword">const</span> center_scaled = center / scale

  <span class="hljs-comment">// Scale and resize the canvas to adjust for width of emoji</span>
  context.<span class="hljs-title function_">clearRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable constant_">EMOJI_SIZE</span>, <span class="hljs-variable constant_">EMOJI_SIZE</span>)
  context.<span class="hljs-title function_">save</span>()
  context.<span class="hljs-title function_">scale</span>(scale, scale)

  <span class="hljs-comment">// context.fillText(char, bottom, left)</span>
  context.<span class="hljs-title function_">fillText</span>(char, center_scaled, center_scaled)
  context.<span class="hljs-title function_">restore</span>()

  <span class="hljs-comment">// We need it to be an image</span>
  <span class="hljs-keyword">return</span> canvas.<span class="hljs-title function_">toDataURL</span>(<span class="hljs-string">&quot;image/png&quot;</span>)
}</code></pre><p>We make a canvas, draw a centered piece of favicon text, then convert that canvas drawing into a png <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/Data_URIs" context="[object Object]">data url</a>. We can set favicons with data urls, so at this point, we just need to add our favicon to the site!</p><h4 id="favioli-üëä-building-favioli-structure-of-a-browser-extension-content-script:-appending-favicons">Content Script: Appending Favicons</h4><p>The last step of Favioli is appending a favicon to the site we visit. Appending a favicon to an existing site can have a few complications, mainly stemming from the fact that different sites apply their favicons in different ways. We have a few different cases that affect how Favioli adds favicons:</p><h5 id="favioli-üëä-building-favioli-structure-of-a-browser-extension-content-script:-appending-favicons-1.-custom-favicon-path">1. Custom Favicon Path</h5><p>This is the easiest to deal with; when a site has a custom favicon path, we can be assured that it has a favicon, and we can either override it or leave it be, depending on our settings.</p><h5 id="favioli-üëä-building-favioli-structure-of-a-browser-extension-content-script:-appending-favicons-2.-weird-path-changes">2. Weird path changes</h5><p>Sometimes a site changes path and expects the favicon to persist through the site. To maintain consistency, and to avoid unnecessary work, favioli memoizes the decision of whether a site has a custom favicon within the context of a session.</p><h5 id="favioli-üëä-building-favioli-structure-of-a-browser-extension-content-script:-appending-favicons-3.-no-favicon-in-the-html">3. No Favicon in the HTML</h5><p>When there is no specified favicon, there are two things it could mean. It could mean that a website is either using the default <code>favicon.ico</code>, or it doesn‚Äôt have a favicon. It could be confusing if we try to determine which of these is happening, though. So instead, Favioli simply appends a <code>favicon.ico</code> link after it appends our emoji favicon in cases where we shouldn‚Äôt override the default emoji. This way, our emoji favicon gets overridden by the default one.</p><pre><code class="language-javascript"><span class="hljs-keyword">const</span> href = <span class="hljs-title function_">memoizedEmojiUrl</span>(name);

<span class="hljs-keyword">if</span> (existingFavicon) {
  existingFavicon.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&quot;href&quot;</span>, href);
} <span class="hljs-keyword">else</span> {
  <span class="hljs-keyword">const</span> link = <span class="hljs-title function_">createLink</span>(href, <span class="hljs-variable constant_">EMOJI_SIZE</span>, <span class="hljs-string">&quot;image/png&quot;</span>);
  existingFavicon = documentHead.<span class="hljs-title function_">appendChild</span>(link);

  <span class="hljs-keyword">if</span> (!shouldOverride) {
    <span class="hljs-keyword">const</span> defaultLink = <span class="hljs-title function_">createLink</span>(<span class="hljs-string">&quot;/favicon.ico&quot;</span>);
    documentHead.<span class="hljs-title function_">appendChild</span>(defaultLink);
  }
}</code></pre><h2 id="favioli-üëä-by-jove-we-have-done-it">BY JOVE WE HAVE DONE IT</h2><p>At this point, we have appended a text emoji as a favicon, so we‚Äôve successfully completed our mission to emoji-fy the universe! With Favioli, we no longer need to worry about the dreaded favicon-less existence that some people still somehow call life.</p><h2 id="favioli-üëä-where-do-we-go-from-here?">Where do we go from here?</h2><p>There are a myriad of ways we can extend Favioli in the future.  To give you an idea, here are some ideas we have been thinking about:</p><h4 id="favioli-üëä-where-do-we-go-from-here?-custom-sets-for-randomly-selected-emojis">Custom sets for Randomly Selected Emojis</h4><p>This would be the easiest way to deal with cross-platform compatibility; just change the set that we randomly select from. This will let people better customize their experience.</p><h4 id="favioli-üëä-where-do-we-go-from-here?-custom-sets-for-randomly-selected-emojis-custom-pngs-as-favicons">Custom pngs as Favicons</h4><p>This would create more utility for Favioli. I feel our default offering is better than most favicon replacement extensions. But not being able to set custom pngs is a real killer from being the best one out there. Also, though‚Ä¶ gif favicons.  Imagine how hilarious (and technically dumb) that could be. Using pngs as a fallback could also be used for browsers, os that are insufficient for life and don‚Äôt have the new emojis.</p><h4 id="favioli-üëä-where-do-we-go-from-here?-custom-sets-for-randomly-selected-emojis-custom-application-overrides">Custom Application Overrides</h4><p>It would be cool to be able to override some aspects of page load in a smarter and more fun way. Image üò≠ emojis for 404/500 page responses, üëÄ for non-https sites or something like that. These would be configured in settings, but could be a fun way to interact with the web.</p><h4 id="favioli-üëä-where-do-we-go-from-here?-custom-sets-for-randomly-selected-emojis-popup-page">Popup Page</h4><p>This is a pretty obvious one; A useful UI update</p><h4 id="favioli-üëä-where-do-we-go-from-here?-custom-sets-for-randomly-selected-emojis-stats-for-nerds">Stats for nerds</h4><p>Being able to apply Favioli to browser history would be fun. We‚Äôd have to play with permission settings so that Favioli is only enabled on this page, but could be interesting‚Ä¶</p><p>Anywhoooooo‚Ä¶</p><p>This is Favioli!  Check it out! Send a PR if you want a feature, or just use it!
<a href="https://favioli.com" context="[object Object]">Favioli</a>
<a href="https://github.com/ivebencrazy/favioli" context="[object Object]">Source Code</a></p><p>üòò ‚ù§Ô∏èü§Ø, Ben Pevsner</p><p><a href="https://static.bpev.me/images/favioli-favioli.png" target="_blank"><img src="https://static.bpev.me/images/favioli-favioli.png?width=750&amp;height=750&amp;fit=outside" alt="Favioli" class="col-12 image"/></a></p></div></section></div><footer class="footer sans-serif col-12 pt4 pb4 mt4"><div class="row white p2">Made by Ben Pevsner</div><div class="row p2"><a href="https://github.com/ivebencrazy" class="white p2 o5 text-decoration-none">github</a><a href="https://ivebencrazy.bandcamp.com/" class="white p2 o5 text-decoration-none">bandcamp</a><a href="https://www.youtube.com/channel/UCpznF0d3ky603SFPzJwtT0g" class="white p2 o5 text-decoration-none">youtube</a></div></footer></div></body></html>