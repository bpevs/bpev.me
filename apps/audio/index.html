<!DOCTYPE html>
<body>
  <div id="media-container">
    <img src="https://vx1.bpev.me/vx1.svg" id="art" />

    <div id="media">
      <h1 id="current"></h1>

      <div id="controls">
        <audio id="player" controls>
          <source id="source" />
        </audio>
      </div>
      <div id="skip">
        <img src="/icon/skip-back.svg" id="back" />
        <img src="/icon/skip-forward.svg" id="forward" />
      </div>
    </div>

    <div id="media-list-container">
      <ol id="media-list">
      </ol>
    </div>
  </svg>
  </div>
</body>

<script>
const path = window.location.pathname;
const sourceUrl = `https://static.bpev.me${path}`;
const mediaListEl = document.getElementById('media-list');
const audioEl = document.getElementById('player');
const sourceEl = document.getElementById('source');
const currentSongTitleEl = document.getElementById('current');

let curr = 0;
let currEl;

fetchPlaylist().then(playlistArr => {
  sourceEl.setAttribute('src', playlistArr[0].file);
  currentSongTitleEl.innerHTML = playlistArr[0].title;
  audioEl.load();

  playlistArr.forEach((track, index) => {
    const title = document.createElement('li');
    title.innerHTML = `
      <span class="num">${((index + 1) < 10 ? '0' : '') + (index + 1)}</span>
      <span class="title">${track.title}</span>`;
    title.onclick = () => switchTrack(index);
    mediaListEl.appendChild(title);
  });

  document.getElementById('forward').onclick = () => switchTrack(Math.min(curr + 1, playlistArr.length))
  document.getElementById('back').onclick = () => switchTrack(Math.max(curr - 1, 0));

  function switchTrack(index) {
    curr = index;
    const track = playlistArr[index];
    if (!track) return false;

    sourceEl.setAttribute('src', track.file);
    currentSongTitleEl.innerHTML = track.title;
    audioEl.load();
    audioEl.play();
    return true;
  }
});

// Parser adapted from https://github.com/nickdesaulniers/javascript-playlist-parser/blob/master/src/pls.coffee
async function fetchPlaylist() {
  const tracks = [];
  const matcher = /(file|title|length)(\d+)=(.+)\r?/i;
  const response = await fetch(sourceUrl);
  const playlistText = await response.text();

  playlistText.trim().split('\n').forEach(line => {
    const match = line.match(matcher);
    if (match?.length !== 4) return;
    const [_, key, index, value] = match;
    if (!tracks[index]) tracks[index] = {};
    tracks[index][key.toLowerCase()] = value;
  });

  return tracks.filter(track => Object.keys(track));
}
</script>

<style>
  body {
    width:  100%;
    height: 100%;
    margin: 0;
    font-family: sans-serif;
  }

  #media-container {
    background: linear-gradient(30deg, #2f42a6, #000723, #ac9cdd);
    background-size: 600% 600%;
    border-radius: 8px;
    color: white;
    display: flex;
    height: 200px;
    max-width: 720px;
  }
  #art {
    width: 120px;
    height: 120px;
    align-self: center;
  }
  #media {
    display: flex;
    flex-direction: column;
    justify-content: center;
    flex-grow: 1;
  }
  #current {
    width: 100%;
  }
  #controls {
    display: flex;
    flex-direction: row;
    width: 100%;
  }
  #media-list-container {
    overflow: scroll;
  }
  #media-list {
    margin: 10px;
    padding: 0;
    background-color: white;
    border-radius: 8px;
    overflow: hidden;
    min-width: 200px;
  }
  #media-list li {
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.5);
    padding: 5px;
    cursor: pointer;
  }
  #media-list li:hover {
    background-color: #ac9cdd;
  }
  #media-list li span {
    margin: 0;
    color: black;
  }
  #media-list li .title {
    color: black;
    padding: 5px;
  }
  #media-list li .num {
    padding-left: 5px;
    color: rgba(0, 0, 0, 0.5);
    font-size: 80%;
  }
  #media-list li:last-child {
    border: none;
  }
  #skip {
    vertical-align: middle;
    padding-top: 10px;
  }
  #forward,
  #back {
    padding: 5px;
    border-radius: 8px;
    background-color: rgba(256,256,256,0.9);
    cursor: pointer;
    height: 15px;
    width: 15px;
    vertical-align: middle;
  }

  #forward:hover,
  #back:hover {
    background-color: #ac9cdd;
  }

  @media (max-width: 620px) {
    #art {
      display: none;
    }
    #media {
      padding: 10px;
    }
  }
</style>
</html>
